# Руководство по ручной аннотации датасета для RAG-бенчмарков

## Цель

Ручной датасет (`manual dataset`) нужен для более строгой оценки качества RAG,
чем синтетический golden standard. Аннотация выполняется экспертами и используется
как отдельный режим `--mode manual`.

## Формат записи

Каждая строка датасета — JSON-объект:

```json
{
  "question": "Когда можно подать заявление на повышенную стипендию?",
  "ground_truth_answer": "Заявление подают с 1 по 10 число каждого месяца через личный кабинет.",
  "relevant_chunk_ids": [1201, 1202],
  "relevant_urls": [
    "https://confluence.example.edu/pages/viewpage.action?pageId=1024"
  ],
  "notes": "Вопрос про сроки. Нужны оба чанка: окно подачи и канал подачи."
}
```

Обязательные поля:
- `question`: формулировка реального пользовательского вопроса.
- `ground_truth_answer`: эталонный ответ без галлюцинаций.

Рекомендуемые поля:
- `relevant_chunk_ids`: список id релевантных чанков из таблицы `Chunk`.
- `relevant_urls`: список релевантных Confluence URL.
- `notes`: комментарий аннотатора (пограничные случаи, допущения, контекст).

## Принципы аннотации

1. **Фактичность:** эталонный ответ должен опираться только на подтвержденные
   источники.
2. **Полнота:** если для ответа нужны несколько документов, указывайте все
   релевантные `chunk_id` и/или `relevant_urls`.
3. **Минимальная достаточность:** не включайте в `relevant_chunk_ids` документы,
   которые не влияют на корректность ответа.
4. **Стабильность:** одинаковые типы вопросов размечайте по одинаковым правилам.
5. **Трассируемость:** в `notes` фиксируйте неоднозначные решения.

## Edge cases

- **Несколько корректных формулировок ответа:** выбирайте короткий,
  однозначный, проверяемый вариант.
- **Противоречивые источники:** используйте более свежий и официальный источник,
  отметьте конфликт в `notes`.
- **Неполный вопрос:** если смысл не определен, не включайте пример в датасет.

## Минимальные требования качества

- Межаннотаторское согласие по выборке: не ниже 0.8 (Cohen's kappa, где применимо).
- Доля записей с заполненным `notes` в спорных кейсах: 100%.
- Доля записей с пустыми `relevant_chunk_ids` и `relevant_urls`: не более 10%.

## Примеры

```json
{
  "question": "Я на больничном, дедлайн лаб до пятницы. Можно сдать позже без штрафа?",
  "ground_truth_answer": "Да, при наличии подтверждающих документов срок сдачи можно продлить до 14 дней.",
  "relevant_chunk_ids": [3401],
  "relevant_urls": ["https://confluence.example.edu/pages/viewpage.action?pageId=7788"],
  "notes": "Нужен факт про продление и лимит 14 дней."
}
```

```json
{
  "question": "Где посмотреть расписание пересдач по матану?",
  "ground_truth_answer": "Расписание пересдач публикуется в разделе деканата в LMS и обновляется каждую среду.",
  "relevant_chunk_ids": [512, 513],
  "relevant_urls": ["https://confluence.example.edu/pages/viewpage.action?pageId=8899"],
  "notes": "Один чанк про место публикации, второй про периодичность обновления."
}
```
